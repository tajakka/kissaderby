<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Komeetanpoika & Tähtiäinen</title>
	</head>
	<body>
		<canvas id="myCanvas" width="1000" height="600" style="background-image:url('pics/bg.png');"></canvas>
		<script src="http://localhost:80/socket.io/socket.io.js"></script>
		<script>
		
			var socket = io.connect('http://localhost');
			var imagesLoaded=0;
			var stack = []; 
			var derby = new Object();
			var ready = false;
			
			function DerbyState(obj){
				console.log(obj);
				this.status = obj.status;
				this.cats = obj.cats;
				this.tracklenght = obj.tracklenght;
				this.coordinateUpdateInterval = obj.coordinateUpdateInterval;
				this.raceEndDelay = obj.raceEndDelay;
				this.raceStartDelay = obj.raceStartDelay;
				
				this.cps = function(){
					return cats;
					};
			
				setInterval(function(){
					for(var i = 0; i < derby.cats.length; i++){
						if((derby.cats[i].coordinate < derby.tracklenght) && (derby.status == 'on')){
							derby.cats[i].coordinate += Math.floor(derby.cats[i].speed * 100);
							document.getElementById("track"+i).innerHTML=Math.floor(derby.cats[i].coordinate);
						};
					};
				},100);
			};
						
			socket.on('race', function (data) {
				console.log("Speed update");
				cps = JSON.parse(data);
				derby.cats[cps.track].coordinate = cps.coordinate;
				derby.cats[cps.track].speed = cps.speed;
			});

			socket.on('connect', function (data) {
				console.log("Connection established");
				derby = new DerbyState(JSON.parse(data));
				init();
			});
			
			socket.on('update', function (data) {
				console.log("Status update");
				temp = JSON.parse(data);
				derby.status = temp.status;
				for(var i in derby.cats){
					derby.cats = temp.cats;
					};
			});

			/*
			function initialize() {
				for (var i = 0; i < 6; i++) {    
					bg.src = "pics/bg.png";
					bg.onload = function(){
						context.drawImage(bg,0,0,1000,600)
					};
					var img = new Image();
					img.src = 'pics/' + i + '.png'; 
					stack.push(img);
					img.onload = (function(value){
						return function(){
							context.drawImage(stack[value], 0, 0+(value*100), 80, 80);
						}
					})(i);
				};
			};
			*/
			
			window.requestAnimFrame = (function(){
				return  window.requestAnimationFrame       || 
				window.webkitRequestAnimationFrame || 
				window.mozRequestAnimationFrame    || 
				window.oRequestAnimationFrame      || 
				window.msRequestAnimationFrame     || 
					function(/* function */ callback, /* DOMElement */ element){
					window.setTimeout(callback, 1000 / 60);
				};
			})();
			
			var canvas = document.getElementById('myCanvas');
			var context = canvas.getContext('2d');
			

			animate();

			function init() {
				for (var i = 0; i < 6; i++) {    
						var img = new Image();
						img.src = 'pics/' + i + '.png'; 
						stack.push(img);
						img.onload = (function(value){
							return function(){
								context.drawImage(stack[value], 0, 0+(value*100), 80, 80);
							}
						})(i);
				};
				ready = true;
			};

			function animate() {
				requestAnimFrame( animate );
				draw();
			};

			function draw() {
				if(ready){
					var time = new Date().getTime() * 0.002;
					context.clearRect(0, 0, canvas.width, canvas.height);
					for (var i = 0; i < 6; i++){
						context.drawImage(stack[i], derby.cats[i].coordinate/10, 0+(i*100), 80, 80);
					}
				}
			};
			
		</script>
		<p id="track0">Test</p>
		<p id="track1">Test</p>
		<p id="track2">Test</p>
		<p id="track3">Test</p>
		<p id="track4">Test</p>
		<p id="track5">Test</p>
	</body>
</html>